name: Update AirLens Data (Full Pipeline)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'   # ë§¤ì¼ 00:00 UTC (WAQI)
    - cron: '0 2 * * 0'   # ë§¤ì£¼ ì¼ 02:00 UTC (OpenAQ + Earthdata)

permissions:
  contents: write

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: WAQI ì‹¤ì‹œê°„ ë°ì´í„° (ê¸°ì¡´ Node.js ìŠ¤í¬ë¦½íŠ¸)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  update-waqi:
    name: 'WAQI Realtime'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Verify WAQI Token
        run: |
          if [ -z "${{ secrets.WAQI_TOKEN }}" ]; then
            echo "âŒ WAQI_TOKEN not configured"
            exit 1
          fi
          echo "âœ… WAQI_TOKEN found"

      - name: Install Node deps
        run: npm install --no-save axios

      - name: Create waqi data dir
        run: mkdir -p app/data/waqi

      - name: Fetch WAQI data
        env:
          WAQI_TOKEN: ${{ secrets.WAQI_TOKEN }}
        run: node scripts/fetch-waqi-data.js
        timeout-minutes: 10

      - name: Commit WAQI data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "airlens-bot"
          git config user.email "airlens-bot@users.noreply.github.com"
          git add app/data/waqi/
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ“Š Update WAQI data [$(date +'%Y-%m-%d %H:%M UTC')]"
            git push origin main
            echo "âœ… WAQI data pushed"
          else
            echo "â„¹ï¸  No WAQI changes"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: OpenAQ PM2.5 ì‹œê³„ì—´ ë°ì´í„°
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  update-openaq:
    name: 'OpenAQ PM2.5 Timeseries'
    runs-on: ubuntu-latest
    # ë§¤ì£¼ ì¼ìš”ì¼ 02:00 UTC ìŠ¤ì¼€ì¤„ í˜¹ì€ ìˆ˜ë™ dispatch ì‹œë§Œ ì‹¤í–‰
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'schedule' && startsWith(github.event.schedule, '0 2'))
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: pip install requests --break-system-packages

      - name: Verify OpenAQ Key
        run: |
          if [ -z "${{ secrets.OPENAQ_API_KEY }}" ]; then
            echo "âŒ OPENAQ_API_KEY not configured"
            exit 1
          fi
          echo "âœ… OPENAQ_API_KEY found"

      - name: Create openaq data dir
        run: mkdir -p app/data/openaq

      - name: Fetch OpenAQ timeseries
        env:
          OPENAQ_API_KEY: ${{ secrets.OPENAQ_API_KEY }}
        run: python3 scripts/python/fetch_openaq.py
        timeout-minutes: 20

      - name: Build policy effects
        run: python3 scripts/python/build_policy_effect.py

      - name: Commit OpenAQ data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "airlens-bot"
          git config user.email "airlens-bot@users.noreply.github.com"
          git add app/data/openaq/ app/data/policy-impact/
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ“ˆ Update OpenAQ + policy effect data [$(date +'%Y-%m-%d')]"
            git push origin main
            echo "âœ… OpenAQ data pushed"
          else
            echo "â„¹ï¸  No OpenAQ changes"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: NASA Earthdata AOD (ë³„ë„ ì‹¤í–‰, ì£¼ 1íšŒ)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  update-earthdata:
    name: 'NASA Earthdata AOD'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: pip install requests --break-system-packages

      - name: Create earthdata dir
        run: mkdir -p app/data/earthdata

      - name: Fetch Earthdata AOD
        env:
          EARTHDATA_TOKEN: ${{ secrets.EARTHDATA_TOKEN }}
        run: python3 scripts/python/fetch_earthdata_aod.py
        timeout-minutes: 30

      - name: Commit Earthdata
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "airlens-bot"
          git config user.email "airlens-bot@users.noreply.github.com"
          git add app/data/earthdata/
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ›°ï¸  Update Earthdata AOD [$(date +'%Y-%m-%d')]"
            git push origin main
            echo "âœ… Earthdata pushed"
          else
            echo "â„¹ï¸  No Earthdata changes"
          fi
