name: Update WAQI Data

on:
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ìžì • (UTC)
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install --no-save axios
      
      - name: Fetch WAQI data
        env:
          WAQI_TOKEN: ${{ secrets.WAQI_TOKEN }}
        run: |
          mkdir -p app/data/waqi
          node scripts/fetch-waqi-data.js
      
      # â­ ìƒˆë¡œ ì¶”ê°€: config.js ìƒì„± (í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì‚¬ìš©)
      - name: Generate config.js for frontend
        env:
          WAQI_TOKEN: ${{ secrets.WAQI_TOKEN }}
        run: |
          cat > app/js/config.js << 'CONFIGEOF'
          // âš ï¸ Auto-generated by GitHub Actions
          // Do not edit manually - this file is recreated on each deployment
          // Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          const WAQI_CONFIG = {
            token: '${{ secrets.WAQI_TOKEN }}',
            baseURL: 'https://api.waqi.info',
            cacheTimeout: 30 * 60 * 1000  // 30 minutes
          };
          
          if (typeof window !== 'undefined') {
            console.log('âœ… WAQI configuration loaded');
            console.log('   Token:', WAQI_CONFIG.token ? 'Present' : 'Missing');
          }
          CONFIGEOF
          
          echo "âœ… config.js created with token"
      
      # ë°ì´í„°ì™€ config.js ëª¨ë‘ ì»¤ë°‹
      - name: Commit data and config
        run: |
          git config user.name "AirLens Bot"
          git config user.email "bot@airlens.app"
          
          # ë°ì´í„°ì™€ config ì¶”ê°€
          git add app/data/waqi/
          git add app/js/config.js
          
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ“Š Update WAQI data and config - $(date +'%Y-%m-%d %H:%M UTC')"
            git push
          else
            echo "No changes to commit"
          fi
