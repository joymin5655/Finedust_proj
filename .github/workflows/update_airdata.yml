name: Update AirLens Data (Full Pipeline)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'   # Îß§Ïùº 00:00 UTC (WAQI)
    - cron: '0 2 * * 0'   # Îß§Ï£º Ïùº 02:00 UTC (OpenAQ + Earthdata)

permissions:
  contents: write

concurrency:
  group: airdata-update
  cancel-in-progress: false

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Job 1: WAQI Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ (Node.js)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  update-waqi:
    name: 'WAQI Realtime'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Verify WAQI Token
        run: |
          if [ -z "${{ secrets.WAQI_TOKEN }}" ]; then
            echo "‚ùå WAQI_TOKEN not configured"
            exit 1
          fi
          echo "‚úÖ WAQI_TOKEN found"

      - name: Install Node deps
        run: npm install --no-save axios

      - name: Create waqi data dir
        run: mkdir -p app/data/waqi

      - name: Fetch WAQI data
        env:
          WAQI_TOKEN: ${{ secrets.WAQI_TOKEN }}
          SKIP_HISTORY: 'true'
        run: node scripts/fetch-waqi-data.js
        timeout-minutes: 10

      - name: Commit & Push WAQI data
        run: |
          git config user.name "airlens-bot"
          git config user.email "airlens-bot@users.noreply.github.com"
          git add app/data/waqi/
          if ! git diff --staged --quiet; then
            git commit -m "üìä Update WAQI data [$(date +'%Y-%m-%d %H:%M UTC')]"
            for i in 1 2 3; do
              git pull --rebase origin main && git push origin main && echo "‚úÖ WAQI data pushed" && exit 0
              echo "‚è≥ Push attempt $i failed, retrying in 5s..."
              sleep 5
            done
            echo "‚ùå Failed to push after 3 attempts"
            exit 1
          else
            echo "‚ÑπÔ∏è  No WAQI changes"
          fi

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Job 2: OpenAQ PM2.5 ÏãúÍ≥ÑÏó¥ (Ï£º 1Ìöå ÎòêÎäî ÏàòÎèô)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  update-openaq:
    name: 'OpenAQ PM2.5 Timeseries'
    needs: update-waqi
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'schedule' && startsWith(github.event.schedule, '0 2'))
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: pip install requests --break-system-packages

      - name: Verify OpenAQ Key
        run: |
          if [ -z "${{ secrets.OPENAQ_API_KEY }}" ]; then
            echo "‚ùå OPENAQ_API_KEY not configured"
            exit 1
          fi
          echo "‚úÖ OPENAQ_API_KEY found"

      - name: Create openaq data dir
        run: mkdir -p app/data/openaq

      - name: Fetch OpenAQ timeseries
        env:
          OPENAQ_API_KEY: ${{ secrets.OPENAQ_API_KEY }}
        run: python3 scripts/python/fetch_openaq.py
        timeout-minutes: 20

      - name: Build policy effects
        run: python3 scripts/python/build_policy_effect.py

      - name: Commit & Push OpenAQ data
        run: |
          git config user.name "airlens-bot"
          git config user.email "airlens-bot@users.noreply.github.com"
          git add app/data/openaq/ app/data/policy-impact/
          if ! git diff --staged --quiet; then
            git commit -m "üìà Update OpenAQ + policy effect data [$(date +'%Y-%m-%d')]"
            for i in 1 2 3; do
              git pull --rebase origin main && git push origin main && echo "‚úÖ OpenAQ data pushed" && exit 0
              echo "‚è≥ Push attempt $i failed, retrying in 5s..."
              sleep 5
            done
            echo "‚ùå Failed to push after 3 attempts"
            exit 1
          else
            echo "‚ÑπÔ∏è  No OpenAQ changes"
          fi

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Job 3: NASA Earthdata AOD (Ï£º 1Ìöå ÎòêÎäî ÏàòÎèô)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  update-earthdata:
    name: 'NASA Earthdata AOD'
    needs: update-openaq
    runs-on: ubuntu-latest
    if: >
      always() &&
      (github.event_name == 'workflow_dispatch' ||
       (github.event_name == 'schedule' && startsWith(github.event.schedule, '0 2')))
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: pip install requests --break-system-packages

      - name: Create earthdata dir
        run: mkdir -p app/data/earthdata

      - name: Fetch Earthdata AOD
        env:
          EARTHDATA_TOKEN: ${{ secrets.EARTHDATA_TOKEN }}
        run: python3 scripts/python/fetch_earthdata_aod.py
        timeout-minutes: 30

      - name: Commit & Push Earthdata
        run: |
          git config user.name "airlens-bot"
          git config user.email "airlens-bot@users.noreply.github.com"
          git add app/data/earthdata/
          if ! git diff --staged --quiet; then
            git commit -m "üõ∞Ô∏è  Update Earthdata AOD [$(date +'%Y-%m-%d')]"
            for i in 1 2 3; do
              git pull --rebase origin main && git push origin main && echo "‚úÖ Earthdata pushed" && exit 0
              echo "‚è≥ Push attempt $i failed, retrying in 5s..."
              sleep 5
            done
            echo "‚ùå Failed to push after 3 attempts"
            exit 1
          else
            echo "‚ÑπÔ∏è  No Earthdata changes"
          fi
