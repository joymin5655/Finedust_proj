name: ML Pipeline â€” Weather Features + Model Training

on:
  workflow_dispatch:
    inputs:
      train_model:
        description: 'Also train model after collecting features?'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  schedule:
    - cron: '0 4 * * 1'   # ë§¤ì£¼ ì›”ìš”ì¼ 04:00 UTC

permissions:
  contents: write

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: ê¸°ìƒ + AQ í”¼ì²˜ ìˆ˜ì§‘ (Open-Meteo, ë¬´ë£Œ)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  collect-features:
    name: 'Collect Weather + AQ Features'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: pip install requests --break-system-packages

      - name: Create output dirs
        run: mkdir -p app/data/predictions

      - name: Fetch weather features
        run: python3 scripts/python/ml/fetch_weather_features.py
        timeout-minutes: 15

      - name: Commit features
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "airlens-bot"
          git config user.email "airlens-bot@users.noreply.github.com"
          git add app/data/predictions/weather_features.json
          if ! git diff --staged --quiet; then
            git commit -m "ğŸŒ¤ï¸ Update weather features [$(date +'%Y-%m-%d')]"
            git push origin main
            echo "âœ… Weather features committed"
          else
            echo "â„¹ï¸  No feature changes"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: ëª¨ë¸ í•™ìŠµ + ì˜ˆì¸¡ ê·¸ë¦¬ë“œ ìƒì„± (ìˆ˜ë™ ë˜ëŠ” ì¡°ê±´ë¶€)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  train-model:
    name: 'Train PM2.5 Model'
    runs-on: ubuntu-latest
    needs: collect-features
    if: >
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.train_model == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ML deps
        run: |
          pip install scikit-learn pandas numpy joblib xgboost --break-system-packages

      - name: Create model dir
        run: mkdir -p models app/data/predictions

      - name: Pull latest features
        run: git pull origin main

      - name: Train model
        run: python3 scripts/python/ml/train_pm25_model.py
        timeout-minutes: 30

      - name: Commit model artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "airlens-bot"
          git config user.email "airlens-bot@users.noreply.github.com"
          git add models/model_metadata.json app/data/predictions/grid_latest.json
          # model .pklì€ gitignore ëŒ€ìƒ (í¬ê¸°), metadataë§Œ ì»¤ë°‹
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ¤– Update ML model + prediction grid [$(date +'%Y-%m-%d')]"
            git push origin main
            echo "âœ… Model artifacts committed"
          else
            echo "â„¹ï¸  No model changes"
          fi
